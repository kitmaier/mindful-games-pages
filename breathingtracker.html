<!DOCTYPE html>
<html>
	<head>
	</head>
	<!-- TODO: this onkeydown event responds repeatedly when button is held, find out how to disable that -->
	<body id='body' onkeydown="myFunction(event)">
		<p><a href="index.html">Return to games index</a></p>
		<h1>Breathing Tracker</h1>
		<!-- TODO: allow the user to pick 1, 2, 4, or more keypresses per cycle -->
		<p>Let yourself breathe naturally. Hit "A" as you start breathing in, and hit "S" as you start breathing out. Go through a few dozen breaths, then finish on the "A". If you get confused or make a mistake, just reload the page.</p>
		<!-- TODO: create a graph of the timing data -->
		<!-- svg height="200" width="200">
			<circle id='circle' cx="100" cy="100" r="50" stroke="#7799DD" stroke-width="3" fill="#DDEEFF"/>
			Sorry, your browser does not support inline SVG.
		</svg -->
		<p>
		<!-- What I'm going to do: 
				capture "A" and "S" keypresses, store the data
				if "A" and "S" do not alternate, insert a dummy event between repetitions
				display averages of duration of inbreath, outbreath, and full breath
				display raw data of inbreath, outbreath, and full breath
				show graph of breath durations
		-->
		<div id='in_breath_data'></div>
		<div id='out_breath_data'></div>
		<div id='duration_data'></div>
		</p>
		<p id='summary_data'></p>
		<p id='raw_data'></p>
		<script>
			var startTime = (new Date).getTime();
			var lastTime = startTime;
			var data = []
			var inBreathData = []
			var outBreathData = []
			var durationData = []
			var expectedInput = "A"
			var cycleCount = -1
			function myFunction(event) {
				try {
					var x = event.key;
					if (x == "a" || x == "A") {
						x = "A";
					} else if (x == "s" || x == "S") {
						x = "S";
					} else {
						return;
					}
					if(cycleCount==-1) {
						if(x!="A") return;
						startTime = (new Date).getTime();
						lastTime = startTime;
						expectedInput = "S";
						data.push([startTime])
						cycleCount++;
						return;
					}
					var now = (new Date).getTime();
					var timeOffset = now-startTime;
					var stepTime = now-lastTime;
					data.push([timeOffset,stepTime,x]);
					lastTime = now;
					if(x!=expectedInput) cycleCount++;
					if(x=="A") expectedInput = "Q";
					else if(x=="S") expectedInput = "A";
					while(inBreathData.length<cycleCount) inBreathData.push("-/-")
					while(outBreathData.length<cycleCount) outBreathData.push("-/-")
					if(x=="S") inBreathData.push(stepTime)
					if(x=="A") outBreathData.push(stepTime)
					while(durationData.length<Math.min(inBreathData.length,outBreathData.length)) {
						var val1 = inBreathData[durationData.length];
						var val3 = outBreathData[durationData.length];
						if(val1=="-/-"||val3=="-/-") {
							durationData.push("-/-");
						} else {
							durationData.push(val1+val3);
						}
					}
					document.getElementById("in_breath_data").textContent = "In-Breath Timing: "+JSON.stringify(inBreathData);
					document.getElementById("out_breath_data").textContent = "Out-Breath Timing: "+JSON.stringify(outBreathData);
					document.getElementById("duration_data").textContent = "Cycle Duration: "+JSON.stringify(durationData);
					document.getElementById("summary_data").textContent = "Averages: " + avg(inBreathData) + "s + " + avg(outBreathData) + "s = " + avg(durationData) + "s"
					document.getElementById("raw_data").textContent = "Raw data: "+JSON.stringify(data);
				} catch(error) {
					alert(error.message)
				}
			}
			function avg(list) {
				var sum = 0;
				var count = 0;
				for(var k=0; k<list.length; k++) {
					if(list[k]!="-/-") {
						sum += list[k];
						count += 1;
					}
				}
				return (0.001*sum/count).toFixed(3);
			}
		</script>
	</body>
</html>